<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski 3D Map - Komplett Skidguide ‚õ∑Ô∏è</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.124/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.124/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #cesiumContainer { width: 100%; height: 100%; }
        
        /* Side panel */
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(30, 30, 30, 0.95);
            padding: 12px;
            border-radius: 10px;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            width: 340px;
            max-height: 95vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        #controls::-webkit-scrollbar { width: 6px; }
        #controls::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
            margin-bottom: 10px;
        }
        
        .header h1 {
            font-size: 18px;
            flex: 1;
        }
        
        .resort-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background: #333;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .section-header:hover { opacity: 0.8; }
        
        .section-content { font-size: 12px; }
        
        .section.collapsed .section-content { display: none; }
        
        /* Summit panel */
        .summit-panel {
            background: linear-gradient(135deg, #ff6f00 0%, #ff8f00 100%);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .summit-panel.cloudy { background: linear-gradient(135deg, #455a64 0%, #607d8b 100%); }
        .summit-panel.night { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); }
        .summit-panel.snowing { background: linear-gradient(135deg, #0097a7 0%, #00bcd4 100%); }
        
        .summit-icon { font-size: 42px; }
        .summit-title { font-size: 16px; font-weight: bold; margin: 4px 0; }
        .summit-subtitle { font-size: 11px; opacity: 0.9; }
        
        /* Weather comparison */
        .weather-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .weather-station {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }
        
        .weather-station-name { font-size: 10px; font-weight: bold; opacity: 0.8; }
        .weather-station-icon { font-size: 20px; margin: 4px 0; }
        .weather-station-temp { font-size: 18px; font-weight: bold; }
        .weather-station-details { font-size: 9px; opacity: 0.7; margin-top: 2px; }
        
        /* Sun times */
        .sun-times {
            display: flex;
            justify-content: space-around;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 11px;
        }
        
        .sun-time { text-align: center; }
        .sun-time-label { font-size: 9px; opacity: 0.7; }
        
        /* Snow info */
        .snow-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 8px;
        }
        
        .snow-item {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 6px;
            text-align: center;
        }
        
        .snow-item-value { font-size: 16px; font-weight: bold; }
        .snow-item-label { font-size: 9px; opacity: 0.7; }
        
        /* Avalanche warning */
        .avalanche-warning {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .avalanche-warning.low { background: linear-gradient(135deg, #388e3c 0%, #4caf50 100%); }
        .avalanche-warning.moderate { background: linear-gradient(135deg, #f9a825 0%, #fbc02d 100%); }
        .avalanche-warning.considerable { background: linear-gradient(135deg, #ff6f00 0%, #ff9800 100%); }
        .avalanche-warning.high { background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%); }
        .avalanche-warning.extreme { background: linear-gradient(135deg, #880e4f 0%, #c2185b 100%); }
        
        .avalanche-icon { font-size: 24px; }
        .avalanche-text { flex: 1; }
        .avalanche-level { font-weight: bold; font-size: 13px; }
        .avalanche-desc { font-size: 10px; opacity: 0.9; }
        
        /* POI list */
        .poi-list {
            max-height: 120px;
            overflow-y: auto;
        }
        
        .poi-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .poi-item:hover { background: rgba(255,255,255,0.1); }
        .poi-icon { font-size: 14px; }
        .poi-name { flex: 1; }
        .poi-dist { opacity: 0.6; font-size: 10px; }
        
        /* Webcam links */
        .webcam-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .webcam-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 11px;
        }
        
        .webcam-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Legend */
        .legend-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }
        
        .legend-color {
            width: 16px;
            height: 4px;
            border-radius: 2px;
        }
        
        /* Stats bar */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .stat-item { text-align: center; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .stat-label { font-size: 9px; opacity: 0.7; }
        
        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 12px;
            font-family: sans-serif;
            z-index: 2000;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Status bar */
        #status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-family: sans-serif;
            z-index: 1000;
        }
        
        /* Layer toggles in corner */
        #layer-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(30,30,30,0.9);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            font-family: sans-serif;
            color: white;
            font-size: 12px;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            cursor: pointer;
        }
        
        .layer-toggle input { cursor: pointer; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div id="loading">
        <div class="loading-spinner"></div>
        Laddar 3D-karta...
    </div>
    
    <!-- Main control panel -->
    <div id="controls">
        <div class="header">
            <h1>‚õ∑Ô∏è Ski 3D Map</h1>
        </div>
        
        <select class="resort-select" id="resort-select" onchange="flyToResort(this.value)">
            <option value="are">üá∏üá™ √Öre (380m ‚Üí 1420m)</option>
            <option value="salen">üá∏üá™ S√§len/Lindvallen (440m ‚Üí 750m)</option>
            <option value="chamonix">üá´üá∑ Chamonix (1035m ‚Üí 3842m)</option>
            <option value="valgardena">üáÆüáπ Val Gardena (1236m ‚Üí 2518m)</option>
            <option value="innsbruck">üá¶üáπ Nordkette, Innsbruck (860m ‚Üí 2334m)</option>
            <option value="zermatt">üá®üá≠ Zermatt (1620m ‚Üí 3883m)</option>
            <option value="stanton">üá¶üáπ St. Anton (1304m ‚Üí 2811m)</option>
            <option value="verbier">üá®üá≠ Verbier (1500m ‚Üí 3330m)</option>
        </select>
        
        <!-- SUMMIT SUN SECTION -->
        <div class="section summit-panel" id="summit-panel">
            <div class="summit-icon" id="summit-icon">‚è≥</div>
            <div class="summit-title" id="summit-title">Laddar v√§der...</div>
            <div class="summit-subtitle" id="summit-subtitle">H√§mtar data</div>
            
            <div class="weather-compare">
                <div class="weather-station">
                    <div class="weather-station-name">üèòÔ∏è DALSTATION</div>
                    <div class="weather-station-icon" id="valley-icon">--</div>
                    <div class="weather-station-temp" id="valley-temp">--¬∞</div>
                    <div class="weather-station-details" id="valley-details">--</div>
                </div>
                <div class="weather-station">
                    <div class="weather-station-name">üèîÔ∏è TOPPSTATION</div>
                    <div class="weather-station-icon" id="summit-weather-icon">--</div>
                    <div class="weather-station-temp" id="summit-temp">--¬∞</div>
                    <div class="weather-station-details" id="summit-details">--</div>
                </div>
            </div>
            
            <div class="sun-times">
                <div class="sun-time">
                    <div class="sun-time-label">üåÖ Soluppg√•ng</div>
                    <div id="sunrise-time">--:--</div>
                </div>
                <div class="sun-time">
                    <div class="sun-time-label">‚òÄÔ∏è Solen nu</div>
                    <div id="sun-elevation">--¬∞</div>
                </div>
                <div class="sun-time">
                    <div class="sun-time-label">üåÑ Solnedg√•ng</div>
                    <div id="sunset-time">--:--</div>
                </div>
            </div>
        </div>
        
        <!-- SNOW CONDITIONS -->
        <div class="section" id="snow-section">
            <div class="section-header" onclick="toggleSection('snow-section')">
                ‚ùÑÔ∏è Sn√∂f√∂rh√•llanden
            </div>
            <div class="section-content">
                <div class="snow-info">
                    <div class="snow-item">
                        <div class="snow-item-value" id="snow-depth">--</div>
                        <div class="snow-item-label">Sn√∂djup (cm)</div>
                    </div>
                    <div class="snow-item">
                        <div class="snow-item-value" id="snow-24h">--</div>
                        <div class="snow-item-label">Nysn√∂ 24h</div>
                    </div>
                    <div class="snow-item">
                        <div class="snow-item-value" id="snow-7d">--</div>
                        <div class="snow-item-label">Nysn√∂ 7d</div>
                    </div>
                </div>
                <div id="snow-quality" style="text-align: center; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                    Analyserar...
                </div>
            </div>
        </div>
        
        <!-- AVALANCHE WARNING -->
        <div class="section" id="avalanche-section">
            <div class="section-header" onclick="toggleSection('avalanche-section')">
                ‚ö†Ô∏è Lavinfara
            </div>
            <div class="section-content">
                <div class="avalanche-warning moderate" id="avalanche-warning">
                    <div class="avalanche-icon">‚ö†Ô∏è</div>
                    <div class="avalanche-text">
                        <div class="avalanche-level" id="avalanche-level">M√•ttlig (2/5)</div>
                        <div class="avalanche-desc" id="avalanche-desc">Klicka f√∂r mer info</div>
                    </div>
                </div>
                <a href="#" id="avalanche-link" target="_blank" style="display: block; text-align: center; margin-top: 8px; color: #90caf9; font-size: 11px;">
                    üìã Fullst√§ndig lavinrapport ‚Üí
                </a>
            </div>
        </div>
        
        <!-- PISTE STATS -->
        <div class="section" id="piste-section">
            <div class="section-header" onclick="toggleSection('piste-section')">
                üéø Pister & Liftar
            </div>
            <div class="section-content">
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-pistes">--</div>
                        <div class="stat-label">Pister</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-lifts">--</div>
                        <div class="stat-label">Liftar</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-vertical">--</div>
                        <div class="stat-label">H√∂jdmeter</div>
                    </div>
                </div>
                <div class="legend-grid" style="margin-top: 10px;">
                    <div class="legend-item"><span class="legend-color" style="background: #4CAF50;"></span> Gr√∂n (l√§tt)</div>
                    <div class="legend-item"><span class="legend-color" style="background: #2196F3;"></span> Bl√• (medel)</div>
                    <div class="legend-item"><span class="legend-color" style="background: #F44336;"></span> R√∂d (sv√•r)</div>
                    <div class="legend-item"><span class="legend-color" style="background: #212121; border: 1px solid #666;"></span> Svart (expert)</div>
                </div>
                <div style="margin-top: 8px; font-size: 10px; opacity: 0.7;">
                    üü° Streckad linje = Lift
                </div>
            </div>
        </div>
        
        <!-- WEBCAMS -->
        <div class="section" id="webcam-section">
            <div class="section-header" onclick="toggleSection('webcam-section')">
                üì∏ Webcams
            </div>
            <div class="section-content">
                <div class="webcam-grid" id="webcam-grid">
                    <button class="webcam-btn" onclick="openWebcam('resort')">üèîÔ∏è Toppen</button>
                    <button class="webcam-btn" onclick="openWebcam('base')">üèòÔ∏è Dalen</button>
                    <button class="webcam-btn" onclick="openWebcam('windy')">üåç Windy.com</button>
                    <button class="webcam-btn" onclick="openWebcam('snow')">‚ùÑÔ∏è Snow-forecast</button>
                </div>
            </div>
        </div>
        
        <!-- POI: Restaurants, Parking -->
        <div class="section" id="poi-section">
            <div class="section-header" onclick="toggleSection('poi-section')">
                üìç Sev√§rdheter & Service
            </div>
            <div class="section-content">
                <div class="poi-list" id="poi-list">
                    <div style="text-align: center; opacity: 0.6;">Laddar...</div>
                </div>
            </div>
        </div>
        
        <!-- PISTE ASPECT -->
        <div class="section" id="aspect-section">
            <div class="section-header" onclick="toggleSection('aspect-section')">
                üß≠ Pisternas riktning
            </div>
            <div class="section-content">
                <div id="aspect-info" style="font-size: 11px;">
                    <p>Norrv√§nda pister = b√§ttre sn√∂ (mindre sol)</p>
                    <p>Sydv√§nda = tidigare sol, mjukare sn√∂</p>
                    <div id="aspect-chart" style="margin-top: 8px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Layer toggles -->
    <div id="layer-panel">
        <div style="font-weight: bold; margin-bottom: 8px;">üó∫Ô∏è Kartlager</div>
        <label class="layer-toggle">
            <input type="checkbox" id="layer-pois" checked onchange="togglePOIs(this.checked)">
            üìç Visa POIs
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="layer-terrain" checked disabled>
            üèîÔ∏è 3D-terr√§ng
        </label>
    </div>
    
    <div id="status">Initierar...</div>

    <script>
        // ============= CONFIGURATION =============
        const CESIUM_ION_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYTJiOTk4YS1mMjZhLTQ0OGItYWM5OS03MGM2OTViMWZmMzIiLCJpZCI6MjA3NDIsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1NzgyNTQwMTV9.FGQKb-FQYKAhCRvlRnFu0q-GjCZjDvJ3X_WV1_3NRHY';
        
        // ============= SKI RESORTS DATA =============
        const skiResorts = {
            are: {
                name: '√Öre',
                country: 'Sverige',
                lat: 63.3986, lon: 13.0800,
                valleyElevation: 380, summitElevation: 1420,
                aspect: 'SE',
                webcams: {
                    resort: 'https://www.skistar.com/sv/vara-skidorter/are/webbkameror/',
                    windy: 'https://www.windy.com/webcams/Sweden/Jamtland/Are',
                },
                avalanche: 'https://www.lavinprognoser.se/',
                region: 'scandinavia'
            },
            salen: {
                name: 'S√§len/Lindvallen',
                country: 'Sverige',
                lat: 61.1575, lon: 13.2639,
                valleyElevation: 440, summitElevation: 750,
                aspect: 'N',
                webcams: {
                    resort: 'https://www.skistar.com/sv/vara-skidorter/salen/webbkameror/',
                    windy: 'https://www.windy.com/webcams/Sweden/Dalarna/Salen',
                },
                avalanche: 'https://www.lavinprognoser.se/',
                region: 'scandinavia'
            },
            chamonix: {
                name: 'Chamonix',
                country: 'Frankrike',
                lat: 45.9237, lon: 6.8694,
                valleyElevation: 1035, summitElevation: 3842,
                aspect: 'N',
                webcams: {
                    resort: 'https://www.chamonix.com/webcams,43,en.html',
                    windy: 'https://www.windy.com/webcams/France/Auvergne-Rhone-Alpes/Chamonix-Mont-Blanc',
                },
                avalanche: 'https://meteofrance.com/meteo-montagne/alpes-du-nord/risques-avalanche',
                region: 'alps'
            },
            valgardena: {
                name: 'Val Gardena',
                country: 'Italien',
                lat: 46.5300, lon: 11.8508,
                valleyElevation: 1236, summitElevation: 2518,
                aspect: 'NW',
                webcams: {
                    resort: 'https://www.valgardena.it/en/webcam/',
                    windy: 'https://www.windy.com/webcams/Italy/Trentino-Alto-Adige/Val-Gardena',
                },
                avalanche: 'https://avalanche.report/albina-web/en',
                region: 'alps'
            },
            innsbruck: {
                name: 'Nordkette, Innsbruck',
                country: '√ñsterrike',
                lat: 47.2692, lon: 11.3927,
                valleyElevation: 860, summitElevation: 2334,
                aspect: 'N',
                webcams: {
                    resort: 'https://www.nordkette.com/en/service/webcams',
                    windy: 'https://www.windy.com/webcams/Austria/Tyrol/Innsbruck',
                },
                avalanche: 'https://avalanche.report/albina-web/en',
                region: 'alps'
            },
            zermatt: {
                name: 'Zermatt',
                country: 'Schweiz',
                lat: 46.0207, lon: 7.7491,
                valleyElevation: 1620, summitElevation: 3883,
                aspect: 'E',
                webcams: {
                    resort: 'https://www.zermatt.ch/en/Webcams',
                    windy: 'https://www.windy.com/webcams/Switzerland/Valais/Zermatt',
                },
                avalanche: 'https://www.slf.ch/en/avalanche-bulletin-and-snow-situation.html',
                region: 'alps'
            },
            stanton: {
                name: 'St. Anton',
                country: '√ñsterrike',
                lat: 47.1297, lon: 10.2685,
                valleyElevation: 1304, summitElevation: 2811,
                aspect: 'N',
                webcams: {
                    resort: 'https://www.stantonamarlberg.com/en/winter/webcams',
                    windy: 'https://www.windy.com/webcams/Austria/Tyrol/St-Anton-am-Arlberg',
                },
                avalanche: 'https://avalanche.report/albina-web/en',
                region: 'alps'
            },
            verbier: {
                name: 'Verbier',
                country: 'Schweiz',
                lat: 46.0967, lon: 7.2292,
                valleyElevation: 1500, summitElevation: 3330,
                aspect: 'S',
                webcams: {
                    resort: 'https://www.verbier.ch/en/webcams/',
                    windy: 'https://www.windy.com/webcams/Switzerland/Valais/Verbier',
                },
                avalanche: 'https://www.slf.ch/en/avalanche-bulletin-and-snow-situation.html',
                region: 'alps'
            }
        };
        
        // ============= GLOBALS =============
        Cesium.Ion.defaultAccessToken = CESIUM_ION_TOKEN;
        let viewer;
        let pisteEntities = [];
        let poiEntities = [];
        let currentResort = skiResorts.are;
        let showPOIs = true;
        
        const difficultyColors = {
            'novice': Cesium.Color.fromCssColorString('#4CAF50'),
            'easy': Cesium.Color.fromCssColorString('#4CAF50'),
            'intermediate': Cesium.Color.fromCssColorString('#2196F3'),
            'advanced': Cesium.Color.fromCssColorString('#F44336'),
            'expert': Cesium.Color.fromCssColorString('#212121'),
            'freeride': Cesium.Color.fromCssColorString('#9C27B0'),
            'unknown': Cesium.Color.fromCssColorString('#FF9800')
        };

        const weatherCodes = {
            0: { icon: '‚òÄÔ∏è', desc: 'Klart', sunny: true },
            1: { icon: 'üå§Ô∏è', desc: 'Mestadels klart', sunny: true },
            2: { icon: '‚õÖ', desc: 'Delvis molnigt', sunny: true },
            3: { icon: '‚òÅÔ∏è', desc: 'Mulet', sunny: false },
            45: { icon: 'üå´Ô∏è', desc: 'Dimma', sunny: false },
            48: { icon: 'üå´Ô∏è', desc: 'Rimfrost', sunny: false },
            51: { icon: 'üåßÔ∏è', desc: 'Duggregn', sunny: false },
            53: { icon: 'üåßÔ∏è', desc: 'Regn', sunny: false },
            56: { icon: 'üåßÔ∏è', desc: 'Underkylt regn', sunny: false },
            61: { icon: 'üåßÔ∏è', desc: 'L√§tt regn', sunny: false },
            63: { icon: 'üåßÔ∏è', desc: 'Regn', sunny: false },
            65: { icon: 'üåßÔ∏è', desc: 'Kraftigt regn', sunny: false },
            71: { icon: 'üå®Ô∏è', desc: 'L√§tt sn√∂', sunny: false, snow: true },
            73: { icon: 'üå®Ô∏è', desc: 'Sn√∂fall', sunny: false, snow: true },
            75: { icon: '‚ùÑÔ∏è', desc: 'Ymnigt sn√∂fall', sunny: false, snow: true },
            77: { icon: 'üå®Ô∏è', desc: 'Sn√∂korn', sunny: false, snow: true },
            80: { icon: 'üåßÔ∏è', desc: 'Skurar', sunny: false },
            85: { icon: 'üå®Ô∏è', desc: 'Sn√∂byar', sunny: false, snow: true },
            86: { icon: '‚ùÑÔ∏è', desc: 'Kraftiga sn√∂byar', sunny: false, snow: true },
            95: { icon: '‚õàÔ∏è', desc: '√Öska', sunny: false }
        };

        // ============= SUN CALCULATIONS =============
        const SunCalc = {
            rad: Math.PI / 180,
            dayMs: 86400000,
            J1970: 2440588,
            J2000: 2451545,
            
            toJulian(date) { return date.valueOf() / this.dayMs - 0.5 + this.J1970; },
            fromJulian(j) { return new Date((j + 0.5 - this.J1970) * this.dayMs); },
            toDays(date) { return this.toJulian(date) - this.J2000; },
            
            solarMeanAnomaly(d) { return this.rad * (357.5291 + 0.98560028 * d); },
            
            eclipticLongitude(M) {
                const C = this.rad * (1.9148 * Math.sin(M) + 0.02 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M));
                return M + C + this.rad * 102.9372 + Math.PI;
            },
            
            getPosition(date, lat, lng) {
                const lw = this.rad * -lng;
                const phi = this.rad * lat;
                const d = this.toDays(date);
                const M = this.solarMeanAnomaly(d);
                const L = this.eclipticLongitude(M);
                const dec = Math.asin(Math.sin(this.rad * 23.4397) * Math.sin(L));
                const H = (this.rad * (280.16 + 360.9856235 * d) - lw) - Math.atan2(Math.sin(L) * Math.cos(this.rad * 23.4397), Math.cos(L));
                
                return {
                    altitude: Math.asin(Math.sin(phi) * Math.sin(dec) + Math.cos(phi) * Math.cos(dec) * Math.cos(H)) / this.rad,
                    azimuth: (Math.atan2(Math.sin(H), Math.cos(H) * Math.sin(phi) - Math.tan(dec) * Math.cos(phi)) / this.rad + 180) % 360
                };
            },
            
            getTimes(date, lat, lng) {
                const lw = this.rad * -lng;
                const phi = this.rad * lat;
                const d = this.toDays(date);
                const n = Math.round(d - 0.0009 - lw / (2 * Math.PI));
                const ds = 0.0009 + lw / (2 * Math.PI) + n;
                const M = this.solarMeanAnomaly(ds);
                const L = this.eclipticLongitude(M);
                const dec = Math.asin(Math.sin(this.rad * 23.4397) * Math.sin(L));
                const Jnoon = this.J2000 + ds + 0.0053 * Math.sin(M) - 0.0069 * Math.sin(2 * L);
                
                const cosH = (Math.sin(this.rad * -0.833) - Math.sin(phi) * Math.sin(dec)) / (Math.cos(phi) * Math.cos(dec));
                if (Math.abs(cosH) > 1) return { sunrise: null, sunset: null };
                
                const H = Math.acos(cosH) / (2 * Math.PI);
                return {
                    sunrise: this.fromJulian(Jnoon - H),
                    sunset: this.fromJulian(Jnoon + H)
                };
            }
        };

        // ============= INIT =============
        async function initMap() {
            updateStatus('Skapar 3D-vy...');
            
            try {
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: await Cesium.CesiumTerrainProvider.fromIonAssetId(1),
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: true,
                    vrButton: false,
                    infoBox: true,
                    selectionIndicator: true
                });
                
                viewer.imageryLayers.removeAll();
                viewer.imageryLayers.addImageryProvider(await Cesium.IonImageryProvider.fromAssetId(3));
                viewer.scene.globe.depthTestAgainstTerrain = true;
                
                document.getElementById('loading').style.display = 'none';
                flyToResort('are');
                
                // Update sun every minute
                setInterval(updateSunDisplay, 60000);
                
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loading').innerHTML = `<div style="color: #f44336;">Fel: ${error.message}</div>`;
            }
        }

        function flyToResort(resortId) {
            currentResort = skiResorts[resortId];
            document.getElementById('resort-select').value = resortId;
            
            updateStatus(`Flyger till ${currentResort.name}...`);
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(currentResort.lon, currentResort.lat, 12000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-40),
                    roll: 0
                },
                duration: 2,
                complete: () => {
                    const bounds = {
                        west: currentResort.lon - 0.12,
                        east: currentResort.lon + 0.12,
                        south: currentResort.lat - 0.08,
                        north: currentResort.lat + 0.08
                    };
                    
                    // Load all data
                    loadWeatherForResort(currentResort);
                    loadPistesAndLifts(bounds);
                    loadPOIs(bounds);
                    updateAvalancheInfo(currentResort);
                    updateVerticalDrop();
                }
            });
        }

        // ============= WEATHER =============
        async function loadWeatherForResort(resort) {
            try {
                const baseParams = `latitude=${resort.lat}&longitude=${resort.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,cloud_cover,snow_depth&hourly=snowfall&forecast_days=7&timezone=auto`;
                
                const [valleyRes, summitRes] = await Promise.all([
                    fetch(`https://api.open-meteo.com/v1/forecast?${baseParams}&elevation=${resort.valleyElevation}`),
                    fetch(`https://api.open-meteo.com/v1/forecast?${baseParams}&elevation=${resort.summitElevation}`)
                ]);
                
                const valleyData = await valleyRes.json();
                const summitData = await summitRes.json();
                
                const valley = valleyData.current;
                const summit = summitData.current;
                
                const valleyInfo = weatherCodes[valley.weather_code] || { icon: '‚ùì', desc: 'Ok√§nt', sunny: false };
                const summitInfo = weatherCodes[summit.weather_code] || { icon: '‚ùì', desc: 'Ok√§nt', sunny: false };
                
                // Sun calculations
                const now = new Date();
                const sunPos = SunCalc.getPosition(now, resort.lat, resort.lon);
                const sunTimes = SunCalc.getTimes(now, resort.lat, resort.lon);
                
                const isDay = sunPos.altitude > 0;
                const isSunny = summitInfo.sunny && summit.cloud_cover < 40;
                const isSnowing = summitInfo.snow;
                
                // Update summit panel
                const panel = document.getElementById('summit-panel');
                const icon = document.getElementById('summit-icon');
                const title = document.getElementById('summit-title');
                const subtitle = document.getElementById('summit-subtitle');
                
                if (!isDay) {
                    panel.className = 'section summit-panel night';
                    icon.textContent = 'üåô';
                    title.textContent = 'Natt';
                    subtitle.textContent = `Soluppg√•ng ${formatTime(sunTimes.sunrise)}`;
                } else if (isSnowing) {
                    panel.className = 'section summit-panel snowing';
                    icon.textContent = '‚ùÑÔ∏è';
                    title.textContent = 'SN√ñFALL P√Ö TOPPEN!';
                    subtitle.textContent = summitInfo.desc;
                } else if (isSunny) {
                    panel.className = 'section summit-panel';
                    icon.textContent = '‚òÄÔ∏è';
                    title.textContent = 'SOL P√Ö TOPPEN!';
                    subtitle.textContent = `${summitInfo.desc} ‚Ä¢ ${summit.cloud_cover}% moln`;
                } else {
                    panel.className = 'section summit-panel cloudy';
                    icon.textContent = summitInfo.icon;
                    title.textContent = summitInfo.desc;
                    subtitle.textContent = `${summit.cloud_cover}% molnt√§cke`;
                }
                
                // Valley & Summit stations
                document.getElementById('valley-icon').textContent = valleyInfo.icon;
                document.getElementById('valley-temp').textContent = `${Math.round(valley.temperature_2m)}¬∞`;
                document.getElementById('valley-details').textContent = `${resort.valleyElevation}m ‚Ä¢ ${Math.round(valley.wind_speed_10m)} m/s`;
                
                document.getElementById('summit-weather-icon').textContent = summitInfo.icon;
                document.getElementById('summit-temp').textContent = `${Math.round(summit.temperature_2m)}¬∞`;
                document.getElementById('summit-details').textContent = `${resort.summitElevation}m ‚Ä¢ ${Math.round(summit.wind_speed_10m)} m/s`;
                
                // Sun times
                document.getElementById('sunrise-time').textContent = formatTime(sunTimes.sunrise);
                document.getElementById('sunset-time').textContent = formatTime(sunTimes.sunset);
                document.getElementById('sun-elevation').textContent = `${Math.round(sunPos.altitude)}¬∞`;
                
                // Snow data
                const snowfall24h = summitData.hourly.snowfall.slice(0, 24).reduce((a, b) => a + (b || 0), 0);
                const snowfall7d = summitData.hourly.snowfall.reduce((a, b) => a + (b || 0), 0);
                
                document.getElementById('snow-depth').textContent = summit.snow_depth ? Math.round(summit.snow_depth * 100) : '?';
                document.getElementById('snow-24h').textContent = `${snowfall24h.toFixed(0)} cm`;
                document.getElementById('snow-7d').textContent = `${snowfall7d.toFixed(0)} cm`;
                
                // Snow quality assessment
                updateSnowQuality(summit.temperature_2m, snowfall24h, snowfall7d, isSunny);
                
            } catch (error) {
                console.error('Weather error:', error);
                document.getElementById('summit-title').textContent = 'V√§derfel';
            }
        }
        
        function updateSnowQuality(temp, snow24h, snow7d, isSunny) {
            const el = document.getElementById('snow-quality');
            
            if (snow24h > 20 && temp < -2) {
                el.innerHTML = 'üéø <b>POWDER ALERT!</b> Djup nysn√∂!';
                el.style.background = 'linear-gradient(135deg, #1565c0 0%, #42a5f5 100%)';
            } else if (snow24h > 10 && temp < 0) {
                el.innerHTML = '‚ùÑÔ∏è <b>Utm√§rkt!</b> F√§rsk puder';
                el.style.background = 'linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%)';
            } else if (temp < -5 && snow7d > 20) {
                el.innerHTML = '‚úÖ <b>Bra f√∂rh√•llanden</b> ‚Ä¢ Kall & torr sn√∂';
                el.style.background = 'linear-gradient(135deg, #388e3c 0%, #81c784 100%)';
            } else if (temp < 0 && isSunny) {
                el.innerHTML = '‚òÄÔ∏è <b>V√•rskid√•kning!</b> ‚Ä¢ Sol & kyla';
                el.style.background = 'linear-gradient(135deg, #f57c00 0%, #ffb74d 100%)';
            } else if (temp >= 0 && temp < 3) {
                el.innerHTML = '‚ö†Ô∏è <b>Varierande</b> ‚Ä¢ Kan vara mjukt/h√•rt';
                el.style.background = 'linear-gradient(135deg, #ffa000 0%, #ffc107 100%)';
            } else if (temp >= 3) {
                el.innerHTML = '‚ùå <b>Slask</b> ‚Ä¢ F√∂r varmt, √•k tidigt!';
                el.style.background = 'linear-gradient(135deg, #d32f2f 0%, #ef5350 100%)';
            } else {
                el.innerHTML = 'üìä Inga data';
                el.style.background = 'rgba(255,255,255,0.1)';
            }
        }
        
        function updateSunDisplay() {
            if (!currentResort) return;
            const sunPos = SunCalc.getPosition(new Date(), currentResort.lat, currentResort.lon);
            document.getElementById('sun-elevation').textContent = `${Math.round(sunPos.altitude)}¬∞`;
        }
        
        function formatTime(date) {
            if (!date) return '--:--';
            return date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        }

        // ============= AVALANCHE =============
        function updateAvalancheInfo(resort) {
            const warning = document.getElementById('avalanche-warning');
            const level = document.getElementById('avalanche-level');
            const desc = document.getElementById('avalanche-desc');
            const link = document.getElementById('avalanche-link');
            
            // Set link
            link.href = resort.avalanche;
            
            // Simulate avalanche level based on region (in real app, fetch from API)
            // European Avalanche Warning Services: https://www.avalanches.org/
            const levels = ['low', 'moderate', 'considerable', 'high', 'extreme'];
            const levelNames = {
                low: { name: 'L√•g (1/5)', desc: 'Stabila f√∂rh√•llanden', icon: 'üü¢' },
                moderate: { name: 'M√•ttlig (2/5)', desc: 'H√∂j beredskap i branta partier', icon: 'üü°' },
                considerable: { name: 'Betydande (3/5)', desc: 'Varning! Kritiska situationer kan uppst√•', icon: 'üü†' },
                high: { name: 'Stor (4/5)', desc: 'Mycket farliga f√∂rh√•llanden', icon: 'üî¥' },
                extreme: { name: 'Mycket stor (5/5)', desc: 'Livsfarligt! Undvik terr√§ng', icon: '‚ö´' }
            };
            
            // Demo: Set moderate for most places
            const currentLevel = 'moderate';
            const info = levelNames[currentLevel];
            
            warning.className = `avalanche-warning ${currentLevel}`;
            level.textContent = `${info.icon} ${info.name}`;
            desc.textContent = info.desc;
        }

        // ============= PISTES & LIFTS =============
        async function loadPistesAndLifts(bounds) {
            updateStatus('Laddar pister och liftar...');
            
            // Clear existing
            pisteEntities.forEach(e => viewer.entities.remove(e));
            pisteEntities = [];
            
            try {
                const query = `
                    [out:json][timeout:30];
                    (
                        way["piste:type"="downhill"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        way["piste:type"="nordic"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        way["aerialway"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                    );
                    out body;
                    >;
                    out skel qt;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: 'data=' + encodeURIComponent(query)
                });
                
                const data = await response.json();
                
                const nodes = {};
                data.elements.filter(e => e.type === 'node').forEach(n => {
                    nodes[n.id] = { lat: n.lat, lon: n.lon };
                });
                
                let pisteCount = 0, liftCount = 0;
                let aspects = { N: 0, NE: 0, E: 0, SE: 0, S: 0, SW: 0, W: 0, NW: 0 };
                
                data.elements.filter(e => e.type === 'way').forEach(way => {
                    if (!way.nodes || way.nodes.length < 2) return;
                    
                    const coords = way.nodes.map(id => nodes[id]).filter(n => n);
                    if (coords.length < 2) return;
                    
                    const flatCoords = coords.flatMap(n => [n.lon, n.lat]);
                    const isLift = way.tags?.aerialway;
                    const name = way.tags?.name || (isLift ? 'Lift' : 'Pist');
                    
                    // Calculate aspect for pistes
                    if (!isLift && coords.length >= 2) {
                        const bearing = calculateBearing(coords[0], coords[coords.length - 1]);
                        const aspect = bearingToAspect(bearing);
                        aspects[aspect]++;
                    }
                    
                    if (isLift) {
                        const liftType = way.tags?.aerialway;
                        const liftIcon = liftType === 'gondola' ? 'üö°' : liftType === 'cable_car' ? 'üö†' : 'üöü';
                        
                        pisteEntities.push(viewer.entities.add({
                            name: `${liftIcon} ${name}`,
                            polyline: {
                                positions: Cesium.Cartesian3.fromDegreesArray(flatCoords),
                                width: 3,
                                material: new Cesium.PolylineDashMaterialProperty({
                                    color: Cesium.Color.YELLOW,
                                    dashLength: 12
                                }),
                                clampToGround: true
                            },
                            description: `
                                <h3>${liftIcon} ${name}</h3>
                                <p><b>Typ:</b> ${liftType}</p>
                                ${way.tags?.capacity ? `<p><b>Kapacitet:</b> ${way.tags.capacity} pers/h</p>` : ''}
                                ${way.tags?.duration ? `<p><b>Restid:</b> ${way.tags.duration}</p>` : ''}
                            `
                        }));
                        liftCount++;
                    } else {
                        const difficulty = way.tags?.['piste:difficulty'] || 'unknown';
                        const color = difficultyColors[difficulty] || difficultyColors.unknown;
                        const diffText = { novice: 'Gr√∂n', easy: 'Gr√∂n', intermediate: 'Bl√•', advanced: 'R√∂d', expert: 'Svart' };
                        
                        pisteEntities.push(viewer.entities.add({
                            name: `üéø ${name}`,
                            polyline: {
                                positions: Cesium.Cartesian3.fromDegreesArray(flatCoords),
                                width: 4,
                                material: color,
                                clampToGround: true
                            },
                            description: `
                                <h3>üéø ${name}</h3>
                                <p><b>Sv√•righet:</b> ${diffText[difficulty] || difficulty}</p>
                                ${way.tags?.['piste:grooming'] ? `<p><b>Preparering:</b> ${way.tags['piste:grooming']}</p>` : ''}
                            `
                        }));
                        pisteCount++;
                    }
                });
                
                // Update stats
                document.getElementById('stat-pistes').textContent = pisteCount;
                document.getElementById('stat-lifts').textContent = liftCount;
                
                // Update aspect chart
                updateAspectChart(aspects);
                
                updateStatus(`‚úÖ ${pisteCount} pister, ${liftCount} liftar`);
                
            } catch (error) {
                console.error('Piste error:', error);
                updateStatus('‚ö†Ô∏è ' + error.message);
            }
        }
        
        function calculateBearing(start, end) {
            const dLon = (end.lon - start.lon) * Math.PI / 180;
            const lat1 = start.lat * Math.PI / 180;
            const lat2 = end.lat * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
        
        function bearingToAspect(bearing) {
            const aspects = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return aspects[Math.round(bearing / 45) % 8];
        }
        
        function updateAspectChart(aspects) {
            const total = Object.values(aspects).reduce((a, b) => a + b, 0) || 1;
            const chartEl = document.getElementById('aspect-chart');
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
            for (const [dir, count] of Object.entries(aspects)) {
                const pct = Math.round(count / total * 100);
                const color = (dir === 'N' || dir === 'NE' || dir === 'NW') ? '#4CAF50' : 
                              (dir === 'S' || dir === 'SE' || dir === 'SW') ? '#FF9800' : '#2196F3';
                html += `<div style="flex: 1; min-width: 40px; text-align: center; padding: 4px; background: ${color}33; border-radius: 4px;">
                    <div style="font-weight: bold;">${dir}</div>
                    <div style="font-size: 10px;">${pct}%</div>
                </div>`;
            }
            html += '</div>';
            html += '<div style="font-size: 10px; margin-top: 6px; opacity: 0.7;">üü¢ Norr = B√§st sn√∂ | üü† S√∂der = Mest sol</div>';
            chartEl.innerHTML = html;
        }
        
        function updateVerticalDrop() {
            const drop = currentResort.summitElevation - currentResort.valleyElevation;
            document.getElementById('stat-vertical').textContent = `${drop}m`;
        }

        // ============= POIs =============
        async function loadPOIs(bounds) {
            if (!showPOIs) return;
            
            // Clear existing
            poiEntities.forEach(e => viewer.entities.remove(e));
            poiEntities = [];
            
            try {
                const query = `
                    [out:json][timeout:20];
                    (
                        node["amenity"="restaurant"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        node["amenity"="cafe"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        node["tourism"="alpine_hut"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        node["amenity"="parking"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        node["amenity"="fuel"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        node["shop"="ski"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                        node["amenity"="toilets"](${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                    );
                    out body;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: 'data=' + encodeURIComponent(query)
                });
                
                const data = await response.json();
                
                const poiTypes = {
                    restaurant: { icon: 'üçΩÔ∏è', color: '#FF5722', label: 'Restaurang' },
                    cafe: { icon: '‚òï', color: '#795548', label: 'Caf√©' },
                    alpine_hut: { icon: 'üè†', color: '#8D6E63', label: 'Fj√§llstuga' },
                    parking: { icon: 'üÖøÔ∏è', color: '#2196F3', label: 'Parkering' },
                    fuel: { icon: '‚õΩ', color: '#607D8B', label: 'Bensin' },
                    ski: { icon: 'üéø', color: '#9C27B0', label: 'Skiduthyrning' },
                    toilets: { icon: 'üöª', color: '#00BCD4', label: 'Toalett' }
                };
                
                const poiList = document.getElementById('poi-list');
                let listHtml = '';
                
                data.elements.forEach(node => {
                    const type = node.tags?.amenity || node.tags?.tourism || node.tags?.shop;
                    const info = poiTypes[type];
                    if (!info) return;
                    
                    const name = node.tags?.name || info.label;
                    
                    // Add to map
                    const entity = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(node.lon, node.lat, 0),
                        point: {
                            pixelSize: 12,
                            color: Cesium.Color.fromCssColorString(info.color),
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        },
                        label: {
                            text: info.icon,
                            font: '16px sans-serif',
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            pixelOffset: new Cesium.Cartesian2(0, -8),
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        },
                        name: `${info.icon} ${name}`,
                        description: `<h3>${info.icon} ${name}</h3><p>${info.label}</p>`
                    });
                    poiEntities.push(entity);
                    
                    // Add to list
                    listHtml += `<div class="poi-item" onclick="flyToPOI(${node.lon}, ${node.lat})">
                        <span class="poi-icon">${info.icon}</span>
                        <span class="poi-name">${name}</span>
                    </div>`;
                });
                
                poiList.innerHTML = listHtml || '<div style="text-align: center; opacity: 0.6;">Inga POIs hittade</div>';
                
            } catch (error) {
                console.error('POI error:', error);
            }
        }
        
        function flyToPOI(lon, lat) {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1500),
                duration: 1
            });
        }
        
        function togglePOIs(show) {
            showPOIs = show;
            poiEntities.forEach(e => { e.show = show; });
        }

        // ============= WEBCAMS =============
        function openWebcam(type) {
            const resort = currentResort;
            let url;
            
            switch(type) {
                case 'resort':
                    url = resort.webcams?.resort || `https://www.google.com/search?q=${encodeURIComponent(resort.name + ' webcam')}`;
                    break;
                case 'base':
                    url = resort.webcams?.resort || `https://www.google.com/search?q=${encodeURIComponent(resort.name + ' village webcam')}`;
                    break;
                case 'windy':
                    url = resort.webcams?.windy || `https://www.windy.com/webcams?${resort.lat},${resort.lon},12`;
                    break;
                case 'snow':
                    url = `https://www.snow-forecast.com/resorts/${resort.name.replace(/\s+/g, '-')}/6day/mid`;
                    break;
            }
            
            window.open(url, '_blank');
        }

        // ============= UI HELPERS =============
        function toggleSection(sectionId) {
            document.getElementById(sectionId).classList.toggle('collapsed');
        }
        
        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        // Initialize
        initMap();
    </script>
</body>
</html>
